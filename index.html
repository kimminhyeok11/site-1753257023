<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART 재무제표 조회</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* 요청대로 모든 요소를 작게 만듭니다 */
        body, input, select, button, label, p, th, td {
            font-size: 11px;
            line-height: 1.4;
        }
        input, select, button {
            padding: 5px 8px;
        }
        h1 {
            font-size: 14px;
        }
        table {
            font-size: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 p-2 text-xs">

    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-3">
        
        <div class="flex items-center justify-between mb-3 pb-2 border-b">
            <h1 class="text-sm font-bold text-gray-800">DART 재무제표 조회</h1>
            <img src="https://dart.fss.or.kr/images/common/logo_dart.png" alt="DART Logo" class="w-16">
        </div>

        <form id="dart-form" class="space-y-2">
            <!-- 
              API 키는 Vercel 백엔드(api/proxy.js)에서 안전하게 처리되므로 
              여기서는 입력받을 필요가 없습니다.
            -->

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label for="corp_code" class="block font-medium text-gray-600 mb-0.5">고유번호*</label>
                    <input type="text" id="corp_code" placeholder="예: 00126380" required 
                           class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label for="bsns_year" class="block font-medium text-gray-600 mb-0.5">사업연도*</label>
                    <input type="text" id="bsns_year" placeholder="예: 2023" required 
                           class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label for="reprt_code" class="block font-medium text-gray-600 mb-0.5">보고서 코드*</label>
                    <select id="reprt_code" required 
                            class="w-full border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="11011">사업보고서 (11011)</option>
                        <option value="11013">1분기보고서 (11013)</option>
                        <option value="11012">반기보고서 (11012)</option>
                        <option value="11014">3분기보고서 (11014)</option>
                    </select>
                </div>
                <div>
                    <label for="fs_div" class="block font-medium text-gray-600 mb-0.5">개별/연결*</label>
                    <select id="fs_div" required 
                            class="w-full border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="OFS">재무제표 (OFS)</option>
                        <option value="CFS">연결재무제표 (CFS)</option>
                    </select>
                </div>
            </div>

            <button type="submit" 
                    class="w-full bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                조회하기
            </button>
        </form>

        <!-- 로딩 및 메시지 영역 -->
        <div id="message-area" class="mt-3 text-center">
            <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mx-auto hidden"></div>
            <p id="error-message" class="text-red-500 font-medium hidden"></p>
            <p id="success-message" class="text-green-600 font-medium hidden"></p>
        </div>

        <!-- 결과 표시 영역 -->
        <div id="result-area" class="mt-3 overflow-hidden">
            <div id="result-summary" class="mb-2 p-2 bg-gray-50 rounded-md hidden">
                <p><strong>접수번호:</strong> <span id="rcept_no"></span> <a id="dart-link" href="#" target="_blank" class="text-blue-600 hover:underline text-[10px] ml-1">[공시뷰어]</a></p>
                <p><strong>사업연도:</strong> <span id="bsns_year_result"></span></p>
                <p><strong>보고서:</strong> <span id="reprt_code_result"></span></p>
            </div>
            
            <div class="overflow-x-auto w-full">
                <table id="result-table" class="min-w-full bg-white border border-gray-200 hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-1 border-b text-left font-semibold text-gray-600 uppercase tracking-wider">계정명</th>
                            <th class="px-2 py-1 border-b text-right font-semibold text-gray-600 uppercase tracking-wider">당기</th>
                            <th class="px-2 py-1 border-b text-right font-semibold text-gray-600 uppercase tracking-wider">전기</th>
                        </tr>
                    </thead>
                    <tbody id="result-body" class="text-gray-700">
                        <!-- 데이터가 여기에 동적으로 삽입됩니다. -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // DOM 요소
        const form = document.getElementById('dart-form');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const resultArea = document.getElementById('result-area');
        const resultSummary = document.getElementById('result-summary');
        const resultTable = document.getElementById('result-table');
        const resultBody = document.getElementById('result-body');

        // 메시지 코드 매핑
        const errorMessages = {
            '010': '등록되지 않은 키입니다. (백엔드 설정 확인)',
            '011': '사용할 수 없는 키입니다.',
            '012': '접근할 수 없는 IP입니다.',
            '013': '조회된 데이터가 없습니다.',
            '014': '파일이 존재하지 않습니다.',
            '020': '요청 제한을 초과하였습니다.',
            '021': '조회 가능한 회사 개수가 초과하였습니다.',
            '100': '필드의 부적절한 값입니다. 입력값을 확인해주세요.',
            '101': '부적절한 접근입니다.',
            '800': '시스템 점검으로 인한 서비스가 중지 중입니다.',
            '900': '정의되지 않은 오류가 발생하였습니다.',
            '901': '사용자 계정의 개인정보 보유기간이 만료된 키입니다.',
            '500': '서버 오류가 발생했습니다. (프록시 설정 확인)'
        };

        // 폼 제출 이벤트
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            resultSummary.classList.add('hidden');
            resultTable.classList.add('hidden');
            resultBody.innerHTML = '';

            // 2. 폼 값 가져오기 (API 키 제외)
            const corpCode = document.getElementById('corp_code').value;
            const bsnsYear = document.getElementById('bsns_year').value;
            const reprtCode = document.getElementById('reprt_code').value;
            const fsDiv = document.getElementById('fs_div').value;

            // 3. Vercel 프록시 API URL 생성
            const params = new URLSearchParams({
                corp_code: corpCode,
                bsns_year: bsnsYear,
                reprt_code: reprtCode,
                fs_div: fsDiv
            });
            
            // Vercel에 배포된 우리 백엔드 API를 호출
            const proxyApiUrl = `/api/proxy?${params.toString()}`;

            try {
                // 4. API 호출
                const response = await fetch(proxyApiUrl);
                const data = await response.json();

                // 5. API 응답 처리
                if (data.status === '000') {
                    successMessage.textContent = '조회 성공!';
                    successMessage.classList.remove('hidden');
                    displayResults(data.list, bsnsYear, reprtCode);
                } else {
                    // API 레벨 에러
                    const message = errorMessages[data.status] || data.message || '알 수 없는 오류';
                    showError(message);
                }

            } catch (error) {
                // 네트워크 또는 프록시 에러
                console.error('Fetch error:', error);
                showError('데이터를 불러오는 데 실패했습니다. 네트워크 연결을 확인하거나 잠시 후 다시 시도해주세요.');
            } finally {
                loader.classList.add('hidden');
            }
        });

        // 에러 메시지 표시
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // 결과 표시
        function displayResults(list, bsnsYear, reprtCode) {
            if (!list || list.length === 0) {
                showError('수신된 데이터가 없습니다.');
                return;
            }

            // 1. 요약 정보
            const firstItem = list[0];
            document.getElementById('rcept_no').textContent = firstItem.rcept_no;
            document.getElementById('dart-link').href = `https://dart.fss.or.kr/dsaf001/main.do?rcpNo=${firstItem.rcept_no}`;
            document.getElementById('bsns_year_result').textContent = bsnsYear;
            
            const reprtCodeText = {
                '11011': '사업보고서',
                '11013': '1분기보고서',
                '11012': '반기보고서',
                '11014': '3분기보고서'
            };
            document.getElementById('reprt_code_result').textContent = `${reprtCodeText[reprtCode] || reprtCode}`;
            
            resultSummary.classList.remove('hidden');
            resultArea.classList.remove('overflow-hidden');

            // 2. 재무제표 테이블
            const grouped = {};
            list.forEach(item => {
                if (!grouped[item.sj_nm]) grouped[item.sj_nm] = [];
                grouped[item.sj_nm].push(item);
            });

            for (const sj_nm in grouped) {
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-gray-200';
                headerRow.innerHTML = `<td colspan="3" class="px-2 py-1 font-bold text-gray-700">${sj_nm} (${firstItem.currency} 단위)</td>`;
                resultBody.appendChild(headerRow);

                const items = grouped[sj_nm].sort((a, b) => a.ord - b.ord);

                items.forEach(item => {
                    const formatAmount = (amount) => {
                        if (!amount || amount === '-') return '-';
                        return Number(amount).toLocaleString('ko-KR');
                    };

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    
                    let accountName = item.account_nm;
                    if (item.account_detail && item.account_detail !== 'NULL' && item.account_detail !== item.account_nm) {
                        const details = item.account_detail.split(' - ').slice(1).join(' / ');
                        if (details) {
                            accountName = `<span class="block">${item.account_nm}</span><span class="block text-gray-500 text-[10px] pl-2">${details}</span>`;
                        }
                    }

                    row.innerHTML = `
                        <td class="px-2 py-1 align-top">${accountName}</td>
                        <td class="px-2 py-1 align-top text-right whitespace-nowrap">${formatAmount(item.thstrm_amount)}</td>
                        <td class="px-2 py-1 align-top text-right whitespace-nowrap">${formatAmount(item.frmtrm_amount)}</td>
                    `;
                    resultBody.appendChild(row);
                });
            }

            resultTable.classList.remove('hidden');
        }
    </script>
</body>
</html>

