<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART 고유번호 다운로더</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center text-sm">

    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 text-center">
        <img src="https://dart.fss.or.kr/images/common/logo_dart.png" alt="DART Logo" class="w-24 mx-auto mb-4">
        <h1 class="text-lg font-bold text-gray-800 mb-2">DART 고유번호 파일 다운로더</h1>
        <p class="text-gray-600 mb-4 text-xs">
            아래 버튼을 클릭하여 DART에 등록된 모든 회사의 고유번호가 담긴 ZIP 파일을 다운로드합니다.<br>
            이 파일은 매일 새벽 3시 10분에 갱신됩니다.
        </p>
        <p class="text-gray-600 mb-6 text-xs">
            다운로드한 `CORPCODE.zip` 파일의 압축을 풀어 `CORPCODE.xml`을 `public/corp_codes.json`으로 변환한 후, 메인 앱에 사용하세요.
        </p>
        
        <!-- 
            이 버튼은 /api/downloadCorpCodes.js (아래 2번 파일)를 호출합니다.
        -->
        <button id="download-button"
                class="w-full inline-block bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm disabled:opacity-50">
            CORPCODE.zip 다운로드
        </button>
        
        <p id="message" class="text-xs mt-4"></p>
    </div>
    
    <script>
        const downloadButton = document.getElementById('download-button');
        const message = document.getElementById('message');

        downloadButton.addEventListener('click', async (e) => {
            e.preventDefault(); // 버튼 비활성화
            downloadButton.disabled = true;
            message.textContent = '다운로드 준비 중... (파일 크기가 큽니다)';
            message.classList.remove('text-red-500');
            
            try {
                // 1. 우리 서버의 API 라우트 호출
                const response = await fetch('/api/downloadCorpCodes');

                if (!response.ok) {
                    // 서버가 API 키 오류 등 JSON 에러를 보낸 경우
                    const errorData = await response.json();
                    throw new Error(errorData.message || '알 수 없는 서버 오류');
                }
                
                // 2. 응답이 성공적이면 (zip 파일 스트림)
                // 브라우저에서 다운로드를 시작하기 위해 blob으로 변환
                message.textContent = '파일 다운로드 중...';
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // 3. 임시 <a> 태그를 만들어 다운로드 트리거
                const a = document.createElement('a');
                a.href = url;
                a.download = 'CORPCODE.zip'; // 다운로드 파일명 지정
                document.body.appendChild(a);
                a.click();
                
                // 4. 정리
                a.remove();
                window.URL.revokeObjectURL(url);
                message.textContent = '다운로드가 시작되었습니다.';
                
            } catch (error) {
                console.error('Download error:', error);
                message.textContent = `오류: ${error.message}`;
                message.classList.add('text-red-500');
            } finally {
                downloadButton.disabled = false; // 버튼 활성화
            }
        });
    </script>
</body>
</html>

